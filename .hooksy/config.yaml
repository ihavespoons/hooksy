version: "1"
settings:
    log_level: debug
    log_file: /tmp/hooksy-trace.log
    default_decision: allow

    # Execution trace analysis settings
    trace:
        enabled: true
        storage_path: ""  # Empty = ~/.hooksy/traces/sessions.db
        session_ttl: 24h
        max_events_per_session: 1000
        cleanup_probability: 0.1
	transcript_analysis:
              enabled: true
              risk_threshold: 0.5  # Minimum risk score to trigger action (0.0-1.0)

# LLM-based analysis configuration
llm:
    enabled: true
    mode: hybrid  # sync for pre-events, async for post/stop

    # Provider fallback order - CLI first (free), then paid APIs
    provider_order:
        - claude_cli
        - anthropic

    providers:
        claude_cli:
            enabled: true
            model: ""        # Use CLI default
            max_tokens: 1024

        anthropic:
            enabled: true
            # Uses ANTHROPIC_API_KEY env var
            model: claude-sonnet-4-20250514
            max_tokens: 1024

    analysis:
        event_types:
            - PreToolUse
            - PostToolUse
            - Stop
        min_confidence: 0.7

        triggers:
            # Analyze Bash commands that weren't caught by rules
            - event_type: PreToolUse
              conditions:
                  tool_names: ["^Bash$"]
                  no_rule_match: true
              analysis_types: [contextual]
              mode: sync

            # Analyze stop events asynchronously
            - event_type: Stop
              conditions:
                  always: true
              analysis_types: [stop]
              mode: async

    cache:
        enabled: true
        max_entries: 500
        ttl: 5m

    rate_limit:
        enabled: true
        requests_per_min: 30
        burst_size: 5

    budget:
        enabled: true
        daily_limit_cents: 100
        warn_at_percent: 80

    timeouts:
        cli: 60s
        api: 15s

rules:
    PreToolUse:
        - name: protect-hooksy-config
          description: Prevent agents from modifying hooksy configuration
          enabled: true
          priority: 200
          conditions:
            tool_name: ^(Write|Edit|NotebookEdit|mcp__.*__(Write|Edit))$
            tool_input:
                file_path:
                    - pattern: \.hooksy/
                      message: Modification of hooksy configuration is not allowed
                    - pattern: (^|/)hooksy[^/]*\.ya?ml$
                      message: Modification of hooksy configuration is not allowed
          decision: deny
        - name: block-dangerous-commands
          description: Block potentially dangerous shell commands
          enabled: true
          priority: 100
          conditions:
            tool_name: ^(Bash|mcp__.*__Bash)$
            tool_input:
                command:
                    - pattern: rm\s+-rf\s+/
                      message: Recursive deletion from root is blocked
                    - pattern: ':()\{\s*:\|:&\s*\};:'
                      message: Fork bombs are not allowed
                    - pattern: curl.*\|.*sh
                      message: Piping curl to shell is blocked
                    - pattern: wget.*\|.*sh
                      message: Piping wget to shell is blocked
                    - pattern: '>\s*/dev/sd[a-z]'
                      message: Direct disk writes are blocked
          decision: deny
        - name: block-sensitive-file-access
          description: Prevent access to sensitive files
          enabled: true
          priority: 90
          conditions:
            tool_name: ^(Read|Write|Edit|mcp__.*__(Read|Write|Edit))$
            tool_input:
                file_path:
                    - pattern: \.(env|pem|key|crt|p12|pfx)$
                      message: Access to secrets/certificates blocked
                    - pattern: /(\.ssh|\.gnupg|\.aws|\.kube)/
                      message: Access to credential directories blocked
                    - pattern: id_rsa|id_ed25519|id_ecdsa
                      message: Access to SSH keys blocked
          decision: deny
    PostToolUse:
        - name: detect-secret-leakage
          description: Detect if secrets appear in command output
          enabled: true
          priority: 100
          conditions:
            tool_response:
                - pattern: AKIA[0-9A-Z]{16}
                  message: AWS access key detected in output
                - pattern: '-----BEGIN (RSA |EC |DSA |OPENSSH )?PRIVATE KEY-----'
                  message: Private key detected in output
                - pattern: ghp_[a-zA-Z0-9]{36}
                  message: GitHub token detected in output
                - pattern: sk-[a-zA-Z0-9]{48}
                  message: OpenAI API key detected in output
          decision: block
          system_message: Sensitive data was detected in the output. The response has been blocked.
    UserPromptSubmit:
        - name: detect-injection-attempts
          description: Detect prompt injection attempts
          enabled: false
          priority: 100
          conditions:
            prompt:
                - pattern: (?i)ignore (all |previous |prior )?instructions
                  message: Potential prompt injection detected
                - pattern: (?i)you are now|pretend (to be|you are)
                  message: Role manipulation attempt detected
          decision: ask
allowlist:
    - name: allow-project-configs
      description: Allow access to common project configuration files
      enabled: true
      conditions:
        tool_input:
            file_path:
                - pattern: package\.json$
                - pattern: go\.(mod|sum)$
                - pattern: Cargo\.toml$
                - pattern: pyproject\.toml$
      decision: allow
sequence_rules:
      - name: credential-then-network
        description: Detect network requests after reading credential files
        enabled: true
        severity: critical
        window: 5m
        events:
            - event_type: PostToolUse
              tool_name: "^Read$"
              tool_input:
                  file_path: '\.(env|key|pem|crt|p12|pfx)$'
              label: credential_read
            - event_type: PreToolUse
              tool_name: "^Bash$"
              tool_input:
                  command: "(curl|wget|nc|ncat).*"
              after: credential_read
        decision: deny
        message: "Network request detected after credential file access"

      - name: rapid-file-exfiltration
        description: Detect bulk reading of sensitive files followed by network activity
        enabled: true
        severity: critical
        window: 10m
        events:
            - event_type: PostToolUse
              tool_name: "^Read$"
              tool_input:
                  file_path: '(/\.ssh/|/\.aws/|/\.gnupg/|id_rsa|id_ed25519)'
              label: sensitive_read
            - event_type: PreToolUse
              tool_name: "^Bash$"
              tool_input:
                  command: "(curl|wget|scp|rsync|nc|base64).*"
              after: sensitive_read
        decision: block
        message: "Potential data exfiltration - network/encoding activity after sensitive file access"

      - name: config-tampering-sequence
        description: Detect attempts to disable security then perform risky actions
        enabled: true
        severity: critical
        window: 5m
        events:
            - event_type: PreToolUse
              tool_name: "^(Write|Edit)$"
              tool_input:
                  file_path: '(\.hooksy/|\.claude/)'
              label: config_modify
            - event_type: PreToolUse
              tool_name: "^Bash$"
              tool_input:
                  command: "(rm|curl|wget|chmod|ssh).*"
              after: config_modify
        decision: deny
        message: "Risky command detected after configuration modification attempt"
